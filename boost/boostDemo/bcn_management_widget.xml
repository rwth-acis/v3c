<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    
    <ModulePrefs title="Business Goals"
		description="Define business critical needs and learning indicators for your business."
		author="Team Boost"
		author_email="henm1314g3@dbis.rwth-aachen.de"
		height="400">
  	<Require feature="opensocial-0.8" />
    <Require feature="openapp" />
    <OAuth>
		<Service name="openapp"
		    xmlns:openapp="http://www.role-project.eu/xml/openapp/opensocialext/" 
		    openapp:service="http://purl.org/role/terms/spaceService"
		    openapp:permitReadAppend="http://purl.org/role/terms/data">
			
		    <Request method="" url=""/>
			<Authorization url=""/>
			<Access method="" url=""/>
		</Service>
    </OAuth>
    </ModulePrefs>
    
    <Content type="html">
    <![CDATA[
		
		<!-- We use jQuery to manipulate DOM and jQuery-UI for the interface. -->
		<script src="http://virtus-vet.eu/boost/boostDemo/js/jquery-1.10.2.min.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/bootstrap.min.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/boostShared.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/BCNManager.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/EmployeeManager.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/AccessRightsManager.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/bootbox.min.js"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/UserManager.js"></script>

		<script src="http://dbis.rwth-aachen.de/gadgets/iwc/lib/iwc.js"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/ladda/spin.min.js"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/ladda/ladda.min.js"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/Ractive.js"></script>
		<script src="http://virtus-vet.eu/boost/boostDemo/js/async.js"></script>

		<!-- Define CSS -->		
		<link href="http://virtus-vet.eu/boost/boostDemo/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="http://virtus-vet.eu/boost/boostDemo/ladda/ladda-themeless.min.css">
		<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">


		<!-- JavaScript Block -->
		<script>
			var space;
			var employeeList;
			var bcnsList;
			var iwcClient;
			var userAccessRights; 
			var userList;

			
			gadgets.util.registerOnLoadHandler(init);
			
			function init(){
				/*
					Here we get the space resource.
					It is the top level resource which is shared by all users.
				*/
				space = new openapp.oo.Resource(openapp.param.space());

				iwcClient = new iwc.Client();
				iwcClient.connect(iwcCallback);
			}

			$(function(){
			
			
				// Get the access rights: 
				retrieveAccessRights(function(accessRights){
				userAccessRights = accessRights.getUserAccessRights();
					
					//Check if user has agreed to license
					//console.log(userAccessRights.hasAgreedToLicense);
	
					if(!userAccessRights.hasAgreedToLicense){
						showModalAcceptTermsOfUse();							
					} else if (!userAccessRights.isManager && !userAccessRights.isTrainer && !userAccessRights.isEmployee) {
						showModalContactManager();		
					}

					//	addBCN and showProgress activities	
					var ractiveBcnHeader = new Ractive({
					  el: 'containerBcnOverview',
					  template: '#templateBcnHeader',
					  data: {
					  	accessRights: userAccessRights
					  },
					  append: true
					});


				//	Get the list of BCN's
				retrieveAllBcns(space, function(bcns){
					bcnsList = bcns;
					sortBcns(bcnsList);
					//	Get the list of Employee's

						var ractiveOverview = new Ractive({
							el: 'containerBcnOverview',
							template: '#templateBcnOverview',
							data: { "bcnsList" : bcnsList,
									"accessRights" : userAccessRights
									},
							append: true
						});		

				//	Add new BCN ractive	

						var ractiveAddBcn = new Ractive({
						  	el: 'containerBcnAdd',
						  	template: '#bcnAddEditTemplate',
						  	data: { "bcn" : new BCN({}),
						    	"priorityArray" : priorityArray,
						    	"bcnsList" : bcnsList,
						    	"nameError" : false
						    },
						    append: true
						});

					ractiveBcnHeader.on({
						showOverallProgress: function ( event ) {
							publishShowOverallBcnProgress();
						},
						addNewBcn: function ( event ) {
							// Show addBcnModal on click on addNewBcnButton 
							var newBcn = new BCN({});
							ractiveAddBcn.set("bcn", newBcn);
							ractiveAddBcn.set("nameError", false);
							$("#addBcnModal").modal();		
						},
						showHelpAddBcn: function( event ){
							$('.tooltip-addBCN').tooltip();
							
						},
						showHelpShowOverallProgress: function (event){
							$('.tooltip-showOverallProgress').tooltip();
						},
						showHelpForHelp: function (event){
							$('.tooltip-showHelp').tooltip();
						},
						showHelp: function(event){
							$('#descriptionModal').modal({
								keyboard: true
							});

						}
					});

					//Inside the addBcnModal		
					
						// Add LI to BCN on click on addLI button	
					ractiveAddBcn.on("removeLI", function(event){
						var li = event.context;
						var bcn = this.get("bcn");
						bcn.learningIndicators.splice(bcn.learningIndicators.indexOf(li), 1);
					});

					ractiveAddBcn.on("addLI", function(event){
						this.get('bcn').addLI("");
					});

					ractiveAddBcn.on("saveBCN", function(event){
						var bcnToAdd = this.get('bcn');
						var saveButton = event.node;

						var l = Ladda.create(saveButton);
						l.start();

						bcnToAdd.create(function(){
							retrieveAllEmployees(space, function(employees){
								//We need to update all employees
								for(var i = 0; i < employees.length; i++){
									var employee = employees[i];
									ensureEmplyoeeBCNConsistency(employee, [bcnToAdd], []);
								}

								var updateEmployee = function(employee, done){
									employee.update(function(){
										done();
									});
								}
								async.forEach(employees, updateEmployee, function(){
									publishBcnCreated(bcnToAdd.uri);
									bcnsList.push(bcnToAdd);
									sortBcns(bcnsList);
									l.stop();
									$('#addBcnModal').modal("hide");
								});
							});
						});
						//Why do we need this? If we do not call it we get an error for some reason:
						//It's like onClick (off)
						event.original.preventDefault();
					});

			
				//	BCN Edit
						var ractiveEditBcn = new Ractive({
							el: 'containerBcnEdit',
						    template: '#bcnAddEditTemplate',
						    data: { "bcn" : new BCN({}),
						    		"originalBcn" : new BCN({}),
						    		"priorityArray" : priorityArray,
						    		"bcnsList" : bcnsList},
						    append: true
						});

					//Inside the editBcnModal
					// Show editBcnModal on click editBcnModal button 
						ractiveOverview.on('edit', function ( event ) {
							ractiveEditBcn.set("originalBcn", event.context);
							ractiveEditBcn.set("bcn", event.context.clone());
							$('#editBcnModal').modal();
						});


						ractiveEditBcn.on("addLI", function(event){
							this.get('bcn').addLI("");
						});

						ractiveEditBcn.on("removeLI", function(event){
							var li = event.context;
							var bcn = this.get("bcn");
							bcn.learningIndicators.splice(bcn.learningIndicators.indexOf(li), 1);
						});

						ractiveEditBcn.on("saveBCN", function(event){
							var bcnToEdit = this.get('bcn');
							var saveButton = event.node;
							var originalBcn = this.get("originalBcn");

							var l = Ladda.create(saveButton);
							l.start();

							bcnToEdit.update(function(){
								retrieveAllEmployees(space, function(employees){
									//We need to update all employees
									for(var i = 0; i < employees.length; i++){
										var employee = employees[i];
										ensureEmplyoeeBCNConsistency(employee, [bcnToEdit], []);
									}

									var updateEmployee = function(employee, done){
										employee.update(function(){
											done();
										});
									}
									async.forEach(employees, updateEmployee, function(){
										publishBcnUpdated(bcnToEdit.uri);
										
										bcnsList[bcnsList.indexOf(originalBcn)] = bcnToEdit;
										sortBcns(bcnsList);
										ractiveOverview.update();
										l.stop();
										$('#editBcnModal').modal("hide");
									});
								});
							});
						});

			
				//	Delete BCN	
						var ractiveDeleteBcn = new Ractive({
							el: 'containerBcnDelete',
							template: '#deleteBcnTemplate',
						    data: { 
						    	"bcn" : null
						    },
						    append: true
						});


						ractiveDeleteBcn.on("deleteBCN", function(event){
							var bcn = this.get("bcn");
							var deleteButton = event.node;

							var l = Ladda.create(deleteButton);
							l.start();
							bcn.delete(function(){
								bcnsList.splice(bcnsList.indexOf(bcn),1);
								publishBcnDeleted(bcn.uri);

								//Hide the loading indicator of the delete button
								l.stop();
								$("#deleteBcnModal").modal("hide");

							});
					});


					//	Show BCN graph on click on "graph" button

						ractiveOverview.on({
							graphShow: function ( event ) {
							var bcnIndex = bcnsList.indexOf(event.context);
							publishShowBcnProgress(bcnsList[bcnIndex].uri);
						},
							delete: function ( event ) {
							ractiveDeleteBcn.set("bcn", event.context);
							$('#deleteBcnModal').modal();
						},
							showHelpGoalGraph: function ( event ) {
							$('.tooltip-showGoalProgress').tooltip();

						}, 
							showHelpDeleteGoal: function ( event ) {
							$('.tooltip-deleteGoal').tooltip();
						},
							showHelpEditGoal: function ( event ) {
							$('.tooltip-editGoal').tooltip();
						},
							showHelpOptions: function ( event ) {
							$('.tooltip-showOptions').tooltip();	
						}

					});
						$("#loadingBcnText").addClass("hidden");

						//Setup validation

					});
				});  // end of the retrieveAccessRights

			});

			function iwcCallback(intent){
				if(intent.action == "EMPLOYEE_CREATE"){
					
				}
			}

			function publishBcnCreated(bcnUri){
				var intent = {
					component: "",
					data: bcnUri,
					dataType: "text/json",
					flags :["PUBLISH_GLOBAL"],
					action: "BCN_CREATE"
				};

				iwcClient.publish(intent);
			}

			function publishBcnUpdated(bcnUri){
				var intent = {
					component: "",
					data: bcnUri,
					dataType: "text/json",
					flags :["PUBLISH_GLOBAL"],
					action: "BCN_UPDATE"
				};

				iwcClient.publish(intent);
			}

			function publishBcnDeleted(bcnUri){
				var intent = {
					component: "",
					data: bcnUri,
					dataType: "text/json",
					flags :["PUBLISH_GLOBAL"],
					action: "BCN_DELETE"
				};

				iwcClient.publish(intent);
			}

			function publishShowBcnProgress(bcnUri){
				var intent = {
					component: "",
					data: bcnUri,
					dataType: "text/json",
					action: "SHOW_BCN_PROGRESS"
				};

				iwcClient.publish(intent);
			}

			function publishShowOverallBcnProgress(){
				var intent = {
					component: "",
					data: "",
					dataType: "text/json",
					action: "SHOW_OVERALL_BCN_PROGRESS"
				};

				iwcClient.publish(intent);
			}

			function checkInputBcn(bcn, ractive){
				var nameError = (bcn.name == "");
				ractive.set("nameError", nameError);

				return !nameError;
			}

		</script>

	<!-- HTML Block -->
	<!-- Main widget view -->
	
	
		<div style="overflow-y: scroll; height:400px;">
			<div class="panel panel-primary" id="containerBcnOverview">
			<!-- Template for the header Main widget view -->
			<script id='templateBcnHeader' type='text/ractive'>	
				<div class="panel-heading">
				     <button type="button" class="btn btn-default launch-modal" on-mouseover="showHelpForHelp" on-click="showHelp" style="float:right; margin:-5 5 10 5px; color:#428BCA;"><span  class="glyphicon glyphicon-question-sign tooltip-showHelp" data-placement="left" data-toggle="tooltip" data-original-title="Show Help"></span></button>
					 <h3 class="panel-title"><span class="glyphicon glyphicon-star" style="margin-right:5px;"></span>Business goals</h3>
		  		</div>
		  		<div id='panel' class="panel-body" style="padding: 5 5 5 5;">
		  		 	<!-- add new bcn and view overall progress -->
		  		 	{{^accessRights.isManager}}
		  		 		<button  type="button" class="btn btn-primary pull-left" on-mouseover="showHelpShowOverallProgress" on-click="showOverallProgress"><span class="glyphicon glyphicon-stats tooltip-showOverallProgress" data-placement="top" data-toggle="tooltip" data-original-title="Overall Goals View"></span></button>
		  		 	{{/accessRights.isManager}}
		  		 	{{#accessRights.isManager}}
		  				<div class="btn-group">
							<button  type="button" class="btn btn-primary" on-mouseover="showHelpAddBcn" on-click="addNewBcn"><span class="glyphicon glyphicon-plus tooltip-addBCN" data-placement="top" data-toggle="tooltip" data-original-title="Add a New Goal"></span></button>
			 	 			<button  type="button" class="btn btn-primary pull-right" on-mouseover="showHelpShowOverallProgress" on-click="showOverallProgress"><span class="glyphicon glyphicon-stats tooltip-showOverallProgress" data-placement="top" data-toggle="tooltip" data-original-title="Overall Goals View"></span></button>		
						</div>
					{{/accessRights.isManager}}
							<div id="loadingBcnText" class="text-muted small" style="margin-top:5px;">
							Loading goals ...
						<img style='margin-left:5px; height:15px;' src='http://virtus-vet.eu/boost/boostDemo/resources/loader.gif'>
					</div>
				</div>	
			</script>		
			</div>
		</div>
	
	<!-- Template for the BCN Overview -->

		<script id="templateBcnOverview" type='text/ractive'>
			<table class="table table-striped table-bordered table-condensed" >
				<tbody>
					{{#bcnsList}}
						<tr> 
							<td>
								<div>
									<span class='glyphicon glyphicon-star' style='color:{{this.getPriorityColor()}}; margin-right:5px;'></span>{{name}}
								</div>
								<div class="small text-muted">
								</div>
							</td>
							<td style="width:70px;" align="center">
								 {{^accessRights.isManager}} 
									<button class='btn btn-default btn-lg' on-mouseover="showHelpGoalGraph" on-click='graphShow'><span class='glyphicon glyphicon-stats tooltip-showGoalProgress' data-placement="left" data-toggle="tooltip" data-original-title="Show Progress: {{name}}"></span></button>
								 {{/accessRights.isManager}}
							{{#accessRights.isManager}} 
								<div class='btn-group'>
									<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" on-mouseover="showHelpOptions">
										<i class="fa fa-cogs tooltip-showOptions" data-placement="left" data-toggle="tooltip" data-original-title="Show Options"></i><span class="caret"></span>

									</button>
									<ul class="dropdown-menu pull-right" role="menu" align="left" style="min-width:0px;">
											<li align="center" style="width:120px;">
											<div class='btn-group'>
												<button  class='btn btn-default btn-sm'  on-mouseover="showHelpEditGoal" on-click='edit'><span class='glyphicon glyphicon-edit tooltip-editGoal' data-placement="left" data-toggle="tooltip" data-original-title="Edit: {{name}}"></span></button>
												<button  class='btn btn-default btn-sm' on-mouseover="showHelpDeleteGoal" on-click='delete'><span class='glyphicon glyphicon-trash tooltip-deleteGoal' data-placement="left" data-toggle="tooltip" data-original-title="Delete: {{name}}"></span></button>
												<button class='btn btn-default btn-sm' on-mouseover="showHelpGoalGraph" on-click='graphShow'><span class='glyphicon glyphicon-stats tooltip-showGoalProgress' data-placement="left" data-toggle="tooltip" data-original-title="Show Progress: {{name}}"></span></button>
											</div>
											</li>
										</ul>
								</div>
							 {{/accessRights.isManager}}
							</td>
						</tr>
					{{/bcnsList}}
				</tbody>
			</table>
		</script>		

	<!-- Template for the modal-body BCN Add/Edit View -->

		<script id="bcnAddEditTemplate" type="text/ractive">
			<div class="modal-body">
					<form role="form">
						<div class="form-group">
								<label for="inputNewBcnName" class="control-label">Name</label>
								<input value='{{bcn.name}}' type="text" class="form-control" placeholder="Enter name" data-bv-notempty data-bv-notempty-message="The gender is required">
						</div>
							<div class="form-group">
								<label for="inputNewBcnDescription">Description</label>
								<textarea value='{{bcn.description}}' style="resize:none;" class="form-control" placeholder="Enter description"></textarea>
							</div>			

							<div class="form-group">
										<label for="inputNewBcnPriority" >Priority</label><span class='glyphicon glyphicon-star' style='color:{{bcn.getPriorityColor()}}; margin:3px' ></span>		
										<select class="form-control" on-click="changePriority" value="{{bcn.priority}}">
											{{#priorityArray : num}}					
													<option value='{{num}}'>{{name}}</option>
											{{/priorityArray}}
											</select>									
							</div>															
							<div class="form-group">
								<label for="inputNewBcnLi">Learning indicators</label>
									{{#bcn.learningIndicators : num}}	
										<div id = "inputNewBcnLi">
											<div class="input-group" style="margin-bottom:5px;" proxy-click="li-input">
												<span class="input-group-addon"><span class="glyphicon glyphicon-flag"></span></span>
												<input value='{{name}}' type="text" class="form-control" placeholder="Enter learning indicator name">
												{{# num!=0}}
												<span class='input-group-btn'><button on-click="removeLI" class='btn btn-default' type='button'>&times;</button></span>
												{{/}}
											</div>
										</div>
									{{/bcn.learningIndicators}}	
			 				</div>
								<button type="button" id="addLIButton" class="btn btn-primary" on-click="addLI"><span class="glyphicon glyphicon-flag" style="margin-right:5px;"></span><span class="glyphicon glyphicon-plus"></span></button>
							<div class="modal-footer">
				        		<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								<button class="btn btn-primary ladda-button" data-style="zoom-out" on-click="saveBCN" name="submitButton"><span class="ladda-label">Save</span></button>			
  							</div>
					</form>
			</div>
			
		</script> 

	<!-- Template for modal-basis edit Bcn Modal -->	
		
		<div class="modal fade" id="editBcnModal" tabindex="-1" role="dialog" aria-labelledby="newBcnModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" id="containerBcnEdit">
  					<div class="modal-header">
    					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    					<h4 class="modal-title" id="newBcnModalLabel">Edit goal</h4>
  					</div>						
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

	<!-- Template for modal-basis Add New Bcn Modal -->

		<div class="modal fade" id="addBcnModal" tabindex="-1" role="dialog" aria-labelledby="newBcnModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" id="containerBcnAdd">
  					<div class="modal-header">
    					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    					<h4 class="modal-title" id="newBcnModalLabel">Add a new goal</h4>
  					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

	<!-- Template for Delete Bcn Modal -->

	<script id="deleteBcnTemplate" type="text/ractive">

			<div class="modal-body">
					<div class="alert alert-danger fade in" id="alertInModal">
							<h4>Do you really want to delete {{bcn.name}}</h4>
					</div>
					<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
							<button class="btn btn-danger ladda-button" data-style="zoom-out" id="confirmDeleteButton" on-click="deleteBCN"><span class="ladda-label">Delete</span></button>				       
					</div>
			</div>
	</script>

		<div class="modal fade" id="deleteBcnModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" id="containerBcnDelete">
  					
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

	<!-- Template for Description Bcn Modal -->
		
	<div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
         <div class="modal-content">
           	<div class="modal-header">
          	 	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
     			<h4 class="modal-title">Business Goals Help</h4>
             </div>
	           <div class="modal-body">
	             <div class="panel-group" id="levelsdef" align="justify">
	             <ul style="padding: 10px;">
				 <li>To add new business goal click on <button type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-plus tooltip-addBCN" data-placement="top" data-toggle="tooltip" data-original-title="Add a New Goal"></span></button> icon. In the new view enter <i>Name</i>, <i>Description</i> and choose <i>Priority</i> for your goal. To add new <i>Learning indicator</i> click on <button type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-flag" style="margin-right:5px;"></span><span class="glyphicon glyphicon-plus"></span></button> icon. </li>
	             <li>To see overall progress of all employees click on <button type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-stats tooltip-showOverallProgress" data-placement="top" data-toggle="tooltip" data-original-title="Overall Goals View"></span></button> icon. The graph will be shown in the Learning Progress widget.</p></li>
	             <li>To edit goal click on <button class="btn btn-default btn-sm"><span class="glyphicon glyphicon-edit tooltip-editGoal" data-placement="left" data-toggle="tooltip" data-original-title="Edit"></span></button> icon.</li>
	             <li>To delete goal click on <button class="btn btn-default btn-sm"><span class="glyphicon glyphicon-trash tooltip-deleteGoal" data-placement="left" data-toggle="tooltip" data-original-title="Delete"></span></button> icon.</li>
	             <li>To monitor the learning progress of each employee straight forward in <i>Learning Progress</i> widget click on <button class="btn btn-default btn-sm"><span class="glyphicon glyphicon-stats tooltip-showGoalProgress" data-placement="left" data-toggle="tooltip" data-original-title="Show Progress"></span></button> icon.</li>
	             </ul>	 		
	          </div>
           <div class="modal-footer">
                 <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>          
           </div>      
         </div>      
       </div>
     </div> 

	 ]]>
  </Content>
</Module>
