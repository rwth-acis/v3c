<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    
    <ModulePrefs title="Learning Repository"
		description="Widget to manage learning Documents."
		author="Team Boost"
		author_email="henm1314g3@dbis.rwth-aachen.de"
		height="400">
  	<Require feature="opensocial-0.8" />
    <Require feature="openapp" />
    <OAuth>
		<Service name="openapp"                     
		    xmlns:openapp="http://www.role-project.eu/xml/openapp/opensocialext/" 
		    openapp:service="http://purl.org/role/terms/spaceService"
		    openapp:permitReadAppend="http://purl.org/role/terms/data">
			
		    <Request method="" url=""/>
			<Authorization url=""/>
			<Access method="" url=""/>
		</Service>
    </OAuth>
    </ModulePrefs>
    
    <Content type="html">
    <![CDATA[
		
		<!-- We use jQuery to manipulate DOM and jQuery-UI for the interface. -->
    	<script src="http://virtus-vet.eu/boost/boostPublish/js/jquery-1.10.2.min.js" type="text/javascript"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/bootstrap.min.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/async.js"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/boostShared.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/BCNManager.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/LearningDocumentsManager.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/tree.js" type="text/javascript"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/ladda/spin.min.js"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/ladda/ladda.min.js"></script>
		<script src="http://virtus-vet.eu/boost/boostPublish/js/Ractive.js"></script>
		<script src="http://dbis.rwth-aachen.de/gadgets/iwc/lib/iwc.js"></script>

		<!-- Define CSS -->
		
		<link href="http://virtus-vet.eu/boost/boostPublish/css/bootstrap.min.css" rel="stylesheet">
		<link href="http://virtus-vet.eu/boost/boostPublish/css/tree.css" rel="stylesheet">
		<link rel="stylesheet" href="http://virtus-vet.eu/boost/boostPublish/ladda/ladda-themeless.min.css">
		<!-- JavaScript Block -->
		<script>
			
			var space;
			var iwcClient;
			var bcnsList = new Array();
			var ldsList = {};
			var ldToBeSaved;
			var learningDocumentFromSearchWidget;
			var learningDocuments = [];
			
			
			gadgets.util.registerOnLoadHandler(init);
			function init(){
			    
				space = new openapp.oo.Resource(openapp.param.space());
				iwcClient = new iwc.Client();
				iwcClient.connect(iwcCallback);
			}

			function publishShowLearningDocument(learningDocument){
				var intent = {
					component: "",
					data: "",
					dataType: "text/json",
					action: "SHOW_LEARNING_DOCUMENT",
					extras: learningDocument
				};

				iwcClient.publish(intent);
			}
			
			function iwcCallback(intent){
				if(intent.action == "LEARNING_DOCUMENT_SELECTED"){
					learningDocumentFromSearchWidget = new LearningDocument(intent.extras);
				}

				if(intent.action == "BCN_CREATE"){
					createBCNfromUri(intent.data, function(bcn){
						bcnsList.push(bcn);
						renderAllBCNs();
					});
				}

				if(intent.action == "BCN_UPDATE"){
					createBCNfromUri(intent.data, function(updatedBcn){
						for(var i = 0; i < bcnsList.length; i++){
							var bcn = bcnsList[i];
							if(bcn.uri == intent.data) {
								var oldBcn = bcnsList[i];
								bcnsList[i] = updatedBcn;
							}
						}
						renderAllBCNs();
					});
				}

				if(intent.action == "BCN_DELETE"){
					for(var i = 0; i < bcnsList.length; i++){
						var bcn = bcnsList[i];
						if(bcn.uri == intent.data){
							bcnsList.splice(i, 1);
						}
					}
					renderAllBCNs();
					if(bcnsList.length==0)
						$("#bcns").append("<td>No goals defined.</td>");
				}
			}
			
			$(function(){

			      // help button click 

			      $('#question').click(function(){
			        $('#descriptionModal').modal({
			        keyboard: true
			          });
			        }); 

				$("#importLearningDocumentButton").click(function(){
					if(learningDocumentFromSearchWidget != null){
						$("#inputLdName").val(learningDocumentFromSearchWidget.name);
						$("#inputLdDescription").val(learningDocumentFromSearchWidget.description);
						$("#inputLdLink").val(learningDocumentFromSearchWidget.url)
						ldToBeSaved.type = learningDocumentFromSearchWidget.type;
						ldToBeSaved.contentSpecificData = learningDocumentFromSearchWidget.contentSpecificData;
					}
				});
				retrieveAllBcns(space, function(bcns){
						retrieveAllLearningDocuments(function(lds){
							bcnsList = bcns;
							learningDocuments = lds;

							//We add the learning documents to their respective learning indicators
							//to get a nice tree-like structure of BCN->LI->Document
							for(var i = 0; i < bcns.length; i++){
								var currentBcn = bcns[i];
								ldsList[currentBcn.uri] = {};
								for(var j = 0; j < currentBcn.learningIndicators.length; j++){
									var currentLi = currentBcn.learningIndicators[j];
									currentLi.learningDocuments = [];
									for(var k = learningDocuments.length -1; k >= 0 ; k--){
									    if(learningDocuments[k].bcnUri == currentBcn.uri &&
									    	learningDocuments[k].liId == currentLi.id){
									        currentLi.learningDocuments.push(learningDocuments[k]);
									    	learningDocuments.splice(k, 1);
									    }
									}
								}
							}

							var treeRactive = new Ractive({
					            el: 'bcns',
					            template: '#documentsTreeTemplate',
					            data: { bcns: bcnsList }
					        });
					        treeRactive.on("documentAdd", function(event){
					        	var newDocument = new LearningDocument({});
					        	newDocument.type = "weblink";
					        	var learningIndicatorId = event.context.id;

					        	var kp = event.keypath;
					        	//Keypath has the following form "bcns.0.learningIndicators.0"
					        	//We need the BCN Uri so we have to trim down the keypath to "bcns.0"
					        	var learningIndicatorsKp = kp.slice(0, kp.lastIndexOf("."));
					        	var bcnKp = learningIndicatorsKp.slice(0, learningIndicatorsKp.lastIndexOf("."));

					        	//Now we can get the BCN by providing its keypath to the Ractive .get function
					        	var bcnUri = this.get(bcnKp).uri;

					        	newDocument.bcnUri = bcnUri;
					        	newDocument.liId = learningIndicatorId;

					        	addDocumentRactive.set({
					        		"newDocument": newDocument,
					        		"learningDocumentsArray" : event.context.learningDocuments
					        	});
					        	$("#addLdModal").modal();
					        });
					        treeRactive.on("documentDelete", function(event){
					        	var kp = event.keypath;
					        	learningDocumentsKeypath = kp.slice(0, kp.lastIndexOf("."));

					        	deleteDocumentRactive.set({
					        		"documentArray": this.get(learningDocumentsKeypath),
					        		"document": event.context
					        	});
					        	$("#deleteDocumentModal").modal();
					        });
					        treeRactive.on("documentShow", function(event){
					        	if(event.context.type == "weblink"){
					        		var url = event.context.url;
					        		var http = "http://"
					        		if(!(url.substring(0, http.length) == http))
					        			url = http + url;
					        		window.open(url,'_blank');
					        	}
					        	else
					        		publishShowLearningDocument(event.context);
					        	console.log(event.context.url);
					        });
					        treeRactive.on("documentEdit", function(event){
					        	editDocumentRactive.set("editDocument", event.context);
					        	editDocumentRactive.set("keypath", event.keypath);
					        	$("#editDocumentModal").modal();
					        });
					        $("#documentsTree").tree();

					        var deleteDocumentRactive = new Ractive({
					        	el: 'deleteDocumentTemplateContainer',
					        	template: '#deleteDocumentTemplate',
					        	data: {
					        		documentArray: null,
					        		document: null
					        	}
					        });
					        deleteDocumentRactive.on("deleteDocument", function(event){
					        	var node = event.node;
					        	var l = Ladda.create(node);
					        	l.start();

					        	var document = this.get("document");
					        	var documentArray = this.get("documentArray");
					        	document.delete(function(){
					        		documentArray.splice(documentArray.indexOf(document), 1);
					        		l.stop();
					        		$("#deleteDocumentModal").modal("hide");
					        	});

					        });

					        var editDocumentRactive = new Ractive({
					        	el: 'editDocumentTemplateContainer',
					        	template: '#editDocumentTemplate',
					        	data: {
					        		editDocument: null,
					        		keypath: null
					        	}
					        });
					        editDocumentRactive.on("updateDocument", function(event){
					        	var node = event.node;
					        	var l = Ladda.create(node);
					        	l.start();
					        	var document = this.get("editDocument");
					        	var kp = this.get("keypath");
					        	document.update(function(){
					        		l.stop();
					        		treeRactive.update(kp);
					        		$("#editDocumentModal").modal("hide");
					        	});
					        });

					        var addDocumentRactive = new Ractive({
					        	el: 'addDocumentTemplateContainer',
					        	template: '#addDocumentTemplate',
					        	data: {newDocument: null}
					        });
					        addDocumentRactive.on("saveDocument", function(event){
					        	var node = event.node;
					        	var l = Ladda.create(node);
					        	l.start();
					        	var documentArray = this.get("learningDocumentsArray");
					        	var document = this.get("newDocument");
					        	document.create(function(){
					        		l.stop();
					        		documentArray.push(document);
					        		$("#addLdModal").modal("hide");
					        	});
					        });

					        addDocumentRactive.on("importDocument", function(event){
					        	var document = this.get("newDocument");
					        	learningDocumentFromSearchWidget.bcnUri = document.bcnUri;
					        	learningDocumentFromSearchWidget.liId = document.liId;
					        	this.set("newDocument", learningDocumentFromSearchWidget);
					        });
						});
					}
				);
				
			});
			
		</script>
			
		<!-- HTML Block -->
		<div style="overflow-y: scroll; height:400px;">
		<div class ="panel panel-primary">
			<div class="panel-heading">
				<button id="question" type="button" class="btn btn-default launch-modal" style="float:right; margin:-5 5 10 5px; color:#428BCA;"><span  class="glyphicon glyphicon-question-sign"></span></button>

				<h3 class="panel-title"><span class="glyphicon glyphicon-folder-open" style="margin-right:5px;"></span> Learning Documents</h3>
			</div>
		
			<div id ="panel" class="panel-body">
			<div id="bcns">
				<script id='documentsTreeTemplate' type='text/ractive'>
				<div id="documentsTree" class='tree'>
					<ul>
						{{#bcns}}
				        <li>
							<span>
								<p style="margin-bottom:0px">
									<span style='margin-right:5px; color:{{this.getPriorityColor()}};' class='glyphicon glyphicon-star'></span>{{name}}
								</p>
							</span>
							<ul>
								{{#learningIndicators}}
								 <li>
									<span>
										<p style="margin-bottom:0px">
											<span style='margin-right:5px;' class='glyphicon glyphicon-flag'></span>{{name}}
										</p>
										<p style="margin-bottom:0px; overflow:hidden">
											<small>{{description}}</small>
										</p>
									</span>
									<ul>
										<li>
											<span style="cursor:pointer;" on-click="documentAdd">
												<span style='margin-right:5px;' class='glyphicon glyphicon-plus'></span>Add new document
											</span>
										</li>
										{{#learningDocuments}}
										<li>
											<span>
												<span style='margin-right:5px;' class='glyphicon glyphicon-book'></span>{{name}}
												<div class='btn-group pull-right'>
													<button on-click="documentShow" class='btn btn-default btn-sm'>
														<span class='glyphicon glyphicon-play-circle'></span>
													</button>
													<button on-click="documentEdit" class='btn btn-default btn-sm'>
														<span class='glyphicon glyphicon-edit'></span>
													</button>
													<button on-click="documentDelete" class='btn btn-default btn-sm'>
														<span class='glyphicon glyphicon-trash'></span>
													</button>
												</div>
											</span>
										</li>
										{{/learningDocuments}}
									</ul>
								</li>
								{{/learningIndicators}}
							</ul>
						</li>
						{{/bcns}}
					</ul>
				</div>
				</script>
			</div> 
		</div>
		</div>
		</div>
		
		<div class="modal fade" id="addLdModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div id="addDocumentTemplateContainer">
					<script id='addDocumentTemplate' type='text/ractive'>
  					<div class="modal-header">
    					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    					<h4 class="modal-title" id="myModalLabel">Add a new Learning Document</h4>
  						<p>
  						<button on-click="importDocument" class="btn btn-xs btn-primary"><span class="glyphicon glyphicon-play-circle" style="margin-right:5px;"></span>Import from viewer</button>
  						</p>
  					</div>
  					<div class="modal-body">
    					<form id="addForm" role="form">
								<div class="form-group">
									<label for="inputLdName">Name</label>
									<input value="{{newDocument.name}}" type="text" class="form-control" id="inputLdName" placeholder="Enter name">
								</div>
								<div class="form-group">
									<label for="inputLdDescription">Description</label>
									<textarea value="{{newDocument.description}}" style="resize:none;" class="form-control" id="inputLdDescription" placeholder="Enter description"></textarea>
								</div>
								<div class="form-group">
									<label for="inputLdLink">Link</label>
									<input value="{{newDocument.url}}" type="text" class="form-control" id="inputLdLink" placeholder="Enter url">
			 					</div>
						</form>
					</div>
  					<div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				        <button on-click="saveDocument" type="button" data-style="zoom-out" class="btn btn-primary ladda-button"><span class="ladda-label">Save</span></button>
  					</div>
  					</script>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="editDocumentModal" tabindex="-1" role="dialog" aria-labelledby="editDocumentModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div id="editDocumentTemplateContainer">
					<script id='editDocumentTemplate' type='text/ractive'>
  					<div class="modal-header">
    					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    					<h4 class="modal-title" id="editDocumentModalLabel">Edit learning Document</h4>
  					</div>
  					<div class="modal-body">
    					<form id="addForm" role="form">
								<div class="form-group">
									<label for="inputLdName">Name</label>
									<input value="{{editDocument.name}}" type="text" class="form-control" id="inputLdName" placeholder="Enter name">
								</div>
								<div class="form-group">
									<label for="inputLdDescription">Description</label>
									<textarea value="{{editDocument.description}}" style="resize:none;" class="form-control" id="inputLdDescription" placeholder="Enter description"></textarea>
								</div>
								<div class="form-group">
									<label for="inputLdLink">Link</label>
									<input value="{{editDocument.url}}" type="text" class="form-control" id="inputLdLink" placeholder="Enter url">
			 					</div>
						</form>
					</div>
  					<div class="modal-footer">
				        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				        <button on-click="updateDocument" type="button" data-style="zoom-out" class="btn btn-primary ladda-button"><span class="ladda-label">Update</span></button>
  					</div>
  					</script>
					</div>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="deleteDocumentModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
  					<div class="modal-body">
  						<div id="deleteDocumentTemplateContainer">
  						<script id='deleteDocumentTemplate' type='text/ractive'>
						<div class="alert alert-danger fade in" id="alertInModal">
							<h4 value="" id="deleteAlertText">Do you really want to delete this Learning Document?</h4>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
				       <button type="button" on-click="deleteDocument" data-style="zoom-out" class="btn btn-danger ladda-button"><span class="ladda-label">Delete</span></button>
						</div>
						</script>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Learning Documents Help</h4>
            </div>
          <div class="modal-body">
            <div class="panel-group" id="levelsdef" align="justify">
            <ul style="padding: 10px;">
            	<li>In the <i>Learning Documents</i> widget you can review or add new learning documents assigned to the goal and learning indicators.</li>
          		<li>To see the list of learning indicators assigned to the goal click on its name.</li>
          		<li>To see the list of learning documents assigned to particular learning indicator click on its name.</li>
				<li>To add new learning document click on <i>Add new document</i> menu item. In the <i>Add a new Learning Document</i> view 
				you can import name, description and url from the <i>Boost Viewer</i> widget or enter it in appropriate text fields. Click on <i>Save</i> button to save changes.</li>	
				</li>
            </ul>         
          </div>
          <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>          
          </div>      
        </div>      
      </div>
    </div>
		
		
	]]>
  </Content>
</Module>
